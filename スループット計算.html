<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>5G NR Throughput Simulator (Math Rendered)</title>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <style>
        :root { --primary: #004a99; --secondary: #f0f4f8; --accent: #e63946; --dl-color: #28a745; --ul-color: #fd7e14; }
        body { font-family: "Segoe UI", "Meiryo", sans-serif; line-height: 1.4; background-color: #fcfcfc; color: #333; max-width: 1000px; margin: 0 auto; padding: 20px; }
        .app-container { background: white; border: 1px solid #ddd; border-radius: 12px; overflow: hidden; box-shadow: 0 10px 25px rgba(0,0,0,0.05); }
        .header { background: var(--primary); color: white; padding: 15px; text-align: center; }
        .header h1 { margin: 0; font-size: 1.3rem; }
        .content { padding: 25px; }
        .settings-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 25px; background: #fff; padding: 15px; border: 1px solid #eee; border-radius: 8px; }
        .control-group { display: flex; flex-direction: column; }
        label { font-weight: bold; margin-bottom: 5px; font-size: 0.85rem; color: #555; }
        select, input { padding: 10px; border: 1px solid #ccc; border-radius: 6px; background: white; font-size: 0.95rem; }
        /* 計算式ブロックのデザイン */
        .formula-box { margin: 15px 0 25px 0; background: #fff; padding: 20px; border: 1px solid #004a99; border-radius: 8px; text-align: center; box-shadow: inset 0 2px 4px rgba(0,0,0,0.05); }

        .result-panel { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .res-card { background: var(--secondary); padding: 15px; border-radius: 8px; border: 1px solid #d1d9e0; }
        .dl-header { border-left: 5px solid var(--dl-color); padding-left: 10px; margin-bottom: 10px; color: var(--dl-color); font-size: 1.1rem; }
        .ul-header { border-left: 5px solid var(--ul-color); padding-left: 10px; margin-bottom: 10px; color: var(--ul-color); font-size: 1.1rem; }
        .result-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        .result-table th, .result-table td { padding: 10px; border-bottom: 1px solid #dee2e6; text-align: left; background: white; }
        .result-table th { color: #666; font-weight: normal; width: 60%; }
        .val-text { font-family: "Consolas", monospace; font-weight: bold; color: #333; text-align: right; }
        .main-bps { font-size: 1.2rem; color: var(--accent); }
        .info-box { margin-top: 20px; font-size: 0.8rem; background: #fffbe6; padding: 12px; border-left: 4px solid #ffe58f; border-radius: 4px; }
        .spec-image { width: 100%; margin-top: 30px; text-align: center; }
        .spec-image img { max-width: 100%; border: 1px solid #eee; border-radius: 8px; }
    </style>
</head>
<body>

<div class="app-container">
    <div class="header"><h1>OAIBOX 5G NR スループット計算シミュレータ（sub6）</h1></div>
    <div class="content">
        <div class="settings-grid">
            <div class="control-group">
                <label>チャネル帯域幅</label>
                <select id="bandwidth">
                    <option value="20">20 MHz (51 RB)</option>
                    <option value="40" selected>40 MHz (106 RB)</option>
                    <option value="60">60 MHz (162 RB)</option>
                    <option value="80">80 MHz (217 RB)</option>
                    <option value="100">100 MHz (273 RB)</option>
                </select>
            </div>
            <div class="control-group">
                <label>TDDパターン</label>
                <input type="text" id="tddPattern" value="DDDDDDDFUU">
            </div>
            <div class="control-group">
                <label>MCSテーブル</label>
                <select id="mcsTable" onchange="updateMcsIndices()">
                    <option value="1">Table 1 (64QAM)</option>
                    <option value="2" selected>Table 2 (256QAM)</option>
                </select>
            </div>
            <div class="control-group">
                <label>MCS Index</label>
                <select id="mcsIndex"></select>
            </div>
        </div>

        <div class="formula-box">
            $$ \text{Bitrate [Mbps]} = \frac{N_{RB} \times 12 \times N_{\text{sym/10slot}} \times Q_m \times \frac{R}{1024} \times 200}{10^6} $$
        </div>

        <div class="result-panel">
            <div class="res-card">
                <h3 class="dl-header">Downlink (下り)</h3>
                <table class="result-table">
                    <tr><th>PRB数（NRB）</th><td id="dl-base-prb" class="val-text">-</td></tr>
                    <tr><th>N_sym/10slot</th><td id="dl-sym" class="val-text">-</td></tr>
                    <tr><th>変調次数（Qm）</th><td id="dl-qm" class="val-text">-</td></tr>
                    <tr><th>目標符号化率（R）</th><td id="dl-r1024" class="val-text">-</td></tr>
                    <tr><th>Bitrate (Mbps)</th><td id="dl-bps" class="val-text main-bps">-</td></tr>
                </table>
            </div>
            <div class="res-card">
                <h3 class="ul-header">Uplink (上り)</h3>
                <table class="result-table">
                    <tr><th>PRB数（NRB）</th><td id="ul-base-prb" class="val-text">-</td></tr>
                    <tr><th>N_sym/10slot</th><td id="ul-sym" class="val-text">-</td></tr>
                    <tr><th>変調次数（Qm）</th><td id="ul-qm" class="val-text">-</td></tr>
                    <tr><th>目標符号化率（R）</th><td id="ul-r1024" class="val-text">-</td></tr>
                    <tr><th>Bitrate (Mbps)</th><td id="ul-bps" class="val-text main-bps">-</td></tr>
                </table>
            </div>
        </div>

        <div class="res-card" style="margin-top: 20px; width: 100%; box-sizing: border-box; clear: both;">
            <h3 style="border-left: 5px solid #666; padding-left: 10px; margin-bottom: 15px; color: #333; font-size: 1.1rem;">前提条件</h3>
            <ul style="font-size: 0.85rem; color: #444; padding-left: 20px; line-height: 1.7;">
                <li>5G NRのFR1（sub6）を想定しています。</li>
                <li>サブキャリア間隔（SCS）は30kHzを想定しています。</li>
                <li>計算対象はMAC層とPHY層の間を通るデータを想定しています。</li>
                <li>PUCCH format 0を想定しており、DLスロットすべてを利用可能でない場合があります（3GPP TS38.213 9.2.2参照）。</li>
                <li>DLスロット: 1symbolはPDCCH、1symbolはDMRSが占有（データ有効: 12symbol）と想定しています。</li>
                <li>ULスロット: 1symbolはPUCCH、1.5symbolはDMRSが占有（データ有効: 11.5symbol）と想定しています。</li>
                <li>Fスロット: 1symbolはPDCCH、1symbolはPUCCH、2symbolはDMRS、4symbolはガード時間が占有（データ有効: DL 4 / UL 2）と想定しています。</li>
                <li>SRSやCSI-RSなどのその他のPHY層参照信号は考慮しておらず、これらがオーバーヘッドとなる可能性があります。</li>
                <li>SSBやSIBなどの報知信号は考慮しておらず、これらがオーバーヘッドとなる可能性があります。</li>
                <li>想定条件と異なるシステム（異なるnumerology等）においては、計算結果が大きく乖離する場合があります。</li>
                <li>実機ではHARQ等の再送が発生するため、算出した理論値より低い値が計測されることがあります。</li>
            </ul>
        </div>
    </div>
</div>

<script>
const MCS_TABLES = {
    1: [[0,2,120],[1,2,157],[2,2,193],[3,2,251],[4,2,308],[5,2,379],[6,2,449],[7,2,526],[8,2,602],[9,2,679],[10,4,340],[11,4,378],[12,4,434],[13,4,490],[14,4,553],[15,4,616],[16,4,658],[17,6,438],[18,6,466],[19,6,517],[20,6,567],[21,6,616],[22,6,666],[23,6,719],[24,6,772],[25,6,822],[26,6,873],[27,6,910],[28,6,948]],
    2: [[0,2,120],[1,2,193],[2,2,308],[3,2,449],[4,2,602],[5,4,378],[6,4,434],[7,4,490],[8,4,553],[9,4,616],[10,4,658],[11,6,466],[12,6,517],[13,6,567],[14,6,616],[15,6,666],[16,6,719],[17,6,772],[18,6,822],[19,6,873],[20,8,682.5],[21,8,711],[22,8,754],[23,8,797],[24,8,841],[25,8,885],[26,8,916.5],[27,8,948]]
};
const BW_RB = { "20":51, "40":106, "60":162, "80":217, "100":273 };

function updateMcsIndices() {
    const tableIdx = document.getElementById("mcsTable").value;
    const indexSelect = document.getElementById("mcsIndex");
    indexSelect.innerHTML = "";
    MCS_TABLES[tableIdx].forEach((row, i) => indexSelect.add(new Option("MCS " + i, i)));
    indexSelect.value = (tableIdx == "2") ? 27 : 28;
    calculate();
}

function calculate() {
    const bw = document.getElementById("bandwidth").value;
    const nRB = BW_RB[bw];
    const tableIdx = document.getElementById("mcsTable").value;
    const mcsIndexSelect = document.getElementById("mcsIndex");
    if (!mcsIndexSelect.value) return;

    const mcsIdx = parseInt(mcsIndexSelect.value);
    const [idx, qm, r1024] = MCS_TABLES[tableIdx][mcsIdx];
    const efficiency = qm * (r1024 / 1024);

    const patternArr = document.getElementById("tddPattern").value.toUpperCase().replace(/F/g, 'S').split('');
    const normFactor = 10 / patternArr.length;
    const dCount = patternArr.filter(s => s === 'D').length;
    const uCount = patternArr.filter(s => s === 'U').length;
    const sCount = patternArr.filter(s => s === 'S').length;

    document.getElementById("dl-base-prb").innerText = nRB;
    document.getElementById("ul-base-prb").innerText = nRB;
    document.getElementById("dl-qm").innerText = qm;
    document.getElementById("ul-qm").innerText = qm;
    document.getElementById("dl-r1024").innerText = r1024;
    document.getElementById("ul-r1024").innerText = r1024;

    // DL Calculation
    const dlLimit = (uCount + sCount) * 2;
    const assignedD = Math.min(dCount, dlLimit);
    const assignedS_DL = (assignedD < dlLimit) ? Math.min(sCount, dlLimit - assignedD) : 0;
    const dlSymNorm = ((assignedD * 12) + (assignedS_DL * 4)) * normFactor;
    const dlRENorm = nRB * 12 * dlSymNorm;
    const dlBitsRaw = dlRENorm * qm; // ビット(符号化前)
    const dlBitsCoded = dlBitsRaw * (r1024 / 1024); // ビット (符号化後)

    document.getElementById("dl-sym").innerText = (Math.round(dlSymNorm * 10) / 10).toLocaleString();
    document.getElementById("dl-bps").innerText = (dlBitsCoded / 0.005 / 1e6).toFixed(2) + " Mbps";

    // UL Calculation
    const ulSymNorm = ((uCount * 11.5) + (sCount * 2)) * normFactor;
    const ulRENorm = nRB * 12 * ulSymNorm;
    const ulBitsRaw = ulRENorm * qm;
    const ulBitsCoded = Math.floor(ulBitsRaw * (r1024 / 1024));

    document.getElementById("ul-sym").innerText = (Math.round(ulSymNorm * 10) / 10).toLocaleString();
    document.getElementById("ul-bps").innerText = (ulBitsCoded / 0.005 / 1e6).toFixed(2) + " Mbps";
}

document.querySelectorAll('input, select').forEach(el => el.addEventListener('change', calculate));
window.onload = () => { updateMcsIndices(); calculate(); };
</script>
</body>
</html>